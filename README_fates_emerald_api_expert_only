$CTSMROOT/README_fates_emerald_api_expert_only                                          25/04/2020

plotname="ALP1"
date    ="200417"

######## Download ctsm and update ctsm-fates


######## Adapt ctsm to SAGA


######## Make script grids:
module load NCL/6.6.2-intel-2019b
cd ~/ctsm/tools/mkmapdata
mkdir -p /cluster/shared/noresm/inputdata/share/scripgrids/fates_platform/${plotname}

./mknoocnmap.pl -centerpoint 61.0243,8.12343 -name ${plotname} -dx 0.01 -dy 0.01
mv ~/ctsm/tools/mkmapgrids/SCRIPgrid_*.nc /cluster/shared/noresm/inputdata/share/scripgrids/fates_platform/${plotname}/

#ALP1_noocean_c200417.nc SCRIPgrid_ALP1_nomask_c200417.nc map_ALP1_noocean_to_ALP1_nomask_aave_da_200417.nc  

######## Make domain file:
cd ~/ctsm/cime/tools/mapping/gen_domain_files
mkdir -p /cluster/shared/noresm/inputdata/share/domains/fates_platform/${plotname}
module purge

#### Compile 
#cd src/
#../../../configure --macros-format Makefile --mpilib mpi-serial --machine saga
#. ./.env_mach_specific.sh ; gmake

#### Run
./src/.env_mach_specific.sh
./gen_domain -m /cluster/shared/noresm/inputdata/share/scripgrids/fates_platform/${plotname}/map_${plotname}_noocean_to_${plotname}_nomask_aave_da_${date}.nc -o ${plotname} -l ${plotname}

mv domain.lnd.${plotname}_${plotname}.${date}.nc domain.lnd.${plotname}.${date}.nc
mv domain*.nc /cluster/shared/noresm/inputdata/share/domains/fates_platform/${plotname}/

#domain.ocn.1x1_APL1_ocn.200417.nc domain.lnd.1x1_APL1_1x1_APL1_ocn.200417.nc domain.ocn.1x1_APL1_1x1_APL1_ocn.200417.nc

######## Make mapping file:
cd ~/ctsm/tools/mkmapdata
mkdir -p /cluster/shared/noresm/inputdata/lnd/clm2/mappingdata/maps/fates_platform/${plotname}/
module purge
#module load ESMF/8.0.0-intel-2019b
#module load NCO/4.9.1-intel-2019b 
#module load NCL/6.6.2-intel-2019b
#### Modify regridbatch.sh
#### Run regridbatch.sh
./regridbatch.sh 1x1_${plotname} /cluster/shared/noresm/inputdata/share/scripgrids/fates_platform/${plotname}/SCRIPgrid_${plotname}_nomask_c{date}.nc 
mv map_* /cluster/shared/noresm/inputdata/lnd/clm2/mappingdata/maps/fates_platform/${plotname}/

######## Make surface data file:
cd ~/ctsm/tools/mksurfdata_map
mkdir -p /cluster/shared/noresm/inputdata/lnd/clm2/surfdata_map/fates_platform/${plotname}

#### Compile
##module load netCDF-Fortran/4.5.2-iimpi-2019b
##Modify Makefile.common
##gmake clean
##gmake

#### Run
# ./mksurfdata.pl -no-crop -res usrspec -usr_gname 1x1_km -usr_gdate 200417 -usr_mapdir /cluster/shared/noresm/inputdata/lnd/clm2/mappingdata/maps/fates_platform/ALP1 -dinlc /cluster/shared/noresm/inputdata -hirespft -years "2000" -allownofile
##** trouble getting vegtyp file with:
##Need to modify ~/ctsm/bld/namelist_files/namelist_defaults_clm4_5_tools.xml to have vegtyp file for 2000
## Or change the -years to 2005

./mksurfdata.pl -no-crop -res usrspec -usr_gname 1x1_${plotname} -usr_gdate ${date} -usr_mapdir /cluster/shared/noresm/inputdata/lnd/clm2/mappingdata/maps/fates_platform/${plotname} -dinlc /cluster/shared/noresm/inputdata -hirespft -years "2005" -allownofile

mv surfdata_1x1_${plotname}_hist_16pfts_Irrig_CMIP6_simyr2005_c${date}.nc surfdata_${plotname}_simyr2000.nc

mv surfdata*${plotname}* /cluster/shared/noresm/inputdata/lnd/clm2/surfdata_map/fates_platform/${plotname}


######## Create a case
cd ~/ctsm/cime/scripts

./create_newcase --case ../../../ctsm_cases/2000FATES_seedclim_${plotname} --compset 2000_DATM%1PT_CLM50%FATES_SICE_SOCN_MOSART_SGLC_SWAV --res CLM_USRDAT --machine saga --run-unsupported --project nn2806k

./create_clone --case ../../../ctsm_cases/2000FATES_seedclim_APL1 --clone ../../../ctsm_cases/2000FATES_seedclim1 --project nn2806k
 Successfully created new case 2000FATES_seedclim_APL1 from clone case 2000FATES_seedclim1

######## Build the case
#### Need to modify  ~/ctsm/bld/namelist_files/namelist_defaults_usr_files.xml to point to the correct surface data 
./case.build

######## Run the case
#### Need to modify  ~/ctsm/cime/src/components/data_comps/datm/cime_config/namelist_definition_datm.xml to use specific atm forcing. 








